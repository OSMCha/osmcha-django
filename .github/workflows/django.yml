name: Django CI

on: pull_request

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6

    - name: Create .env file for CI
      run: |
        cat > .env << EOF
        PGHOST=postgres
        PGUSER=postgres
        PGPASSWORD=hunter2
        PGDATABASE=osmcha
        POSTGRES_USER=postgres
        POSTGRES_PASSWORD=hunter2
        POSTGRES_DB=osmcha
        REDIS_URL=redis://redis:6379
        DJANGO_SETTINGS_MODULE=config.settings.tests
        DJANGO_SECRET_KEY=ci-secret-key-shhh
        OAUTH2_OSM_KEY=${{ secrets.OAUTH_OSM_KEY }}
        OAUTH2_OSM_SECRET=${{ secrets.OAUTH_OSM_SECRET }}
        EOF

    - name: Build Django container image
      run: docker compose build django

    - name: Start services
      run: docker compose up -d postgres redis

    - name: Start test container
      run: docker compose run -d --name testrunner --volume /app django tail -f /dev/null

    - name: Install test dependencies
      run: docker exec --user root testrunner pip install -r /requirements/test.txt

    - name: Run migrations
      run: docker exec testrunner python manage.py migrate

    - name: Run tests
      run: docker exec testrunner coverage run manage.py test --settings=config.settings.tests

    - name: Stop test container
      if: always()
      run: docker stop testrunner && docker rm testrunner

    - name: Stop services
      if: always()
      run: docker compose down -v
